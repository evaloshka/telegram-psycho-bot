import os
import random
from datetime import datetime
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler

# === –í–°–¢–ê–í–¨ –°–í–û–ô –¢–û–ö–ï–ù –°–Æ–î–ê (–Ω–æ–≤—ã–π, –Ω–µ —Å—Ç–∞—Ä—ã–π!) ===
BOT_TOKEN = "8595772457:AAHBRzmPpiTAy_FtMCw7Wbkztd-QVDSMK6A"

# --- –°–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ ---
GENDER, MAIN = range(2)

# --- –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ ---
if not os.path.exists("dialogs"):
    os.makedirs("dialogs")

users = {}
user_states = {}

# === –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –æ—Ç–≤–µ—Ç–æ–≤ ===
RESPONSES = {
    "sadness": [
        "–Ø —Å–ª—ã—à—É –≤ —Ç–≤–æ–∏—Ö —Å–ª–æ–≤–∞—Ö –≥—Ä—É—Å—Ç—å. üí≠ –ò–Ω–æ–≥–¥–∞ –±–æ–ª—å –ø—Ä–æ—Å—Ç–æ —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã –µ—ë –∑–∞–º–µ—Ç–∏–ª–∏. –¢—ã –º–æ–∂–µ—à—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ–±—ã—Ç—å —Ä—è–¥–æ–º —Å —ç—Ç–∏–º —á—É–≤—Å—Ç–≤–æ–º ‚Äî –Ω–µ —Ç–æ—Ä–æ–ø—è—Å—å. üåø",
        "–ö–∞–∂–µ—Ç—Å—è, –≤–Ω—É—Ç—Ä–∏ —Å–µ–π—á–∞—Å —Ç—è–∂–µ—Å—Ç—å. üíî –≠—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ ‚Äî —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —É–ø–∞–¥–æ–∫, –∫–æ–≥–¥–∞ –º–Ω–æ–≥–æ–µ –Ω–∞ —Å–µ—Ä–¥—Ü–µ. –ü—Ä–æ—Å—Ç–æ –ø–æ–±—É–¥—å —Ä—è–¥–æ–º —Å —Å–æ–±–æ–π. –ú—ã –≤–µ—Ä–Ω—ë–º—Å—è –∫ —ç—Ç–æ–º—É –Ω–∞ –≥—Ä—É–ø–ø–æ–≤–æ–º —Ä–∞–∑–±–æ—Ä–µ. üïä",
        "–ü–æ—Ö–æ–∂–µ, —Ç–µ–±–µ –≥—Ä—É—Å—Ç–Ω–æ. –ò–Ω–æ–≥–¥–∞ —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç, —á—Ç–æ–±—ã –Ω–∞–ø–æ–º–Ω–∏—Ç—å, –∫–∞–∫ —Å–∏–ª—å–Ω–æ —Ç—ã —Å–ø–æ—Å–æ–±–µ–Ω —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å. üåß"
    ],
    "anxiety": [
        "–Ø —á—É–≤—Å—Ç–≤—É—é —Ç—Ä–µ–≤–æ–≥—É –≤ —Ç–≤–æ–∏—Ö —Å–ª–æ–≤–∞—Ö. üå´ –î—ã—à–∏ –≥–ª—É–±–∂–µ. –ò–Ω–æ–≥–¥–∞ —Ç—Ä–µ–≤–æ–≥–∞ —Ö–æ—á–µ—Ç –∑–∞—â–∏—Ç–∏—Ç—å –Ω–∞—Å –æ—Ç –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏. –ú—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ–± —ç—Ç–æ–º –Ω–∞ —Ä–∞–∑–±–æ—Ä–µ. ü§ç",
        "–ü–æ—Ö–æ–∂–µ, —Ç–µ–±–µ –Ω–µ—Å–ø–æ–∫–æ–π–Ω–æ. üí≠ –≠—Ç–æ —á—É–≤—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–º–æ –º–Ω–æ–≥–∏–º ‚Äî –æ–Ω–æ –Ω–µ –≤—Ä–∞–≥, –ø—Ä–æ—Å—Ç–æ —Å–∏–≥–Ω–∞–ª. –ü–æ–ø—Ä–æ–±—É–π –Ω–∞–π—Ç–∏ –≤ —Ç–µ–ª–µ –º–µ—Å—Ç–æ, –≥–¥–µ –µ—Å—Ç—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∫–æ—è. üå∏",
        "–ò–Ω–æ–≥–¥–∞ —Ç—Ä–µ–≤–æ–≥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –º—ã –¥–æ–ª–≥–æ –¥–µ—Ä–∂–∏–º –≤—Å—ë –≤ —Å–µ–±–µ. üå¨ –ü–æ–ø—Ä–æ–±—É–π –Ω–µ –±–æ—Ä–æ—Ç—å—Å—è —Å –Ω–µ–π ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–∏, –∫–∞–∫ –æ–Ω–∞ –∑–≤—É—á–∏—Ç."
    ],
    "joy": [
        "–ö–∞–∫ –ø—Ä–∏—è—Ç–Ω–æ —Å–ª—ã—à–∞—Ç—å —Ä–∞–¥–æ—Å—Ç—å! üåû –¢—ã –º–æ–∂–µ—à—å –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—â—É—Ç–∏—Ç—å –µ—ë, –±–µ–∑ —Å–æ–º–Ω–µ–Ω–∏–π. –≠—Ç–æ ‚Äî —Ç–æ–∂–µ —á–∞—Å—Ç—å —Ç–µ–±—è. ‚ú®",
        "–Ø —á—É–≤—Å—Ç–≤—É—é —Å–≤–µ—Ç –≤ —Ç–≤–æ–∏—Ö —Å–ª–æ–≤–∞—Ö. ‚òÄÔ∏è –†–∞–¥–æ—Å—Ç—å –≤–∞–∂–Ω–∞, –¥–∞–∂–µ –≤ –ø—Ä–æ—Å—Ç—ã—Ö –≤–µ—â–∞—Ö. –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ —Å–µ–±—è –∑–∞ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç. üíõ",
        "–ö–∞–∫ –∑–¥–æ—Ä–æ–≤–æ, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –∑–∞–º–µ—á–∞—Ç—å –ø—Ä–∏—è—Ç–Ω–æ–µ. üå∏ –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –¥–ª—è –∂–∏–∑–Ω–∏."
    ],
    "anger": [
        "–ü–æ—Ö–æ–∂–µ, –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –∑–ª–æ—Å—Ç—å. üî• –≠—Ç–æ —á—É–≤—Å—Ç–≤–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—â–∏—Ç–æ–π. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–Ω—è—Ç—å, —á—Ç–æ –æ–Ω–æ —Ö–æ—á–µ—Ç —Ç–µ–±–µ —Å–∫–∞–∑–∞—Ç—å. –ú—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ–± —ç—Ç–æ–º –Ω–∞ —Ä–∞–∑–±–æ—Ä–µ. üåø",
        "–¢—ã –∑–ª–∏—à—å—Å—è ‚Äî –∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. üí¢ –ò–Ω–æ–≥–¥–∞ –∑–ª–æ—Å—Ç—å –ø–æ–º–æ–≥–∞–µ—Ç –æ–±–æ–∑–Ω–∞—á–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã. –í–∞–∂–Ω–æ –Ω–µ –ø–æ–¥–∞–≤–ª—è—Ç—å, –∞ —Å–ª—É—à–∞—Ç—å –µ—ë —Å–º—ã—Å–ª. ü§ç",
        "–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ ‚Äî —ç—Ç–æ —á–∞—Å—Ç–æ —Å–ø–æ—Å–æ–± —Ç–µ–ª–∞ —Å–∫–∞–∑–∞—Ç—å: ¬´–º–Ω–µ –±–æ–ª—å–Ω–æ¬ª. üí¨"
    ],
    "fear": [
        "–Ø —Å–ª—ã—à—É —Å—Ç—Ä–∞—Ö –≤ —Ç–≤–æ–∏—Ö —Å–ª–æ–≤–∞—Ö. üå´ –°—Ç—Ä–∞—Ö —á–∞—Å—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –¥–∞—Ç—å —Å–µ–±–µ –æ–ø–æ—Ä—É ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ—á—É–≤—Å—Ç–≤—É–π, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å. üå±",
        "–ü–æ—Ö–æ–∂–µ, —Ç–µ–±–µ —Ç—Ä–µ–≤–æ–∂–Ω–æ –∏ –Ω–µ–º–Ω–æ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ. –≠—Ç–æ —á—É–≤—Å—Ç–≤–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è. ü§≤",
        "–ò–Ω–æ–≥–¥–∞ —Å—Ç—Ä–∞—à–Ω–æ ‚Äî —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º—ã –∂–∏–≤—ã–µ. üí≠ –ò –º—ã –ø–æ–π–¥—ë–º —Ç—É–¥–∞ –±–µ—Ä–µ–∂–Ω–æ, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º."
    ],
    "guilt": [
        "–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –≤–∏–Ω—É... –≠—Ç–æ –Ω–µ–ª–µ–≥–∫–æ–µ —á—É–≤—Å—Ç–≤–æ. üí≠ –ò–Ω–æ–≥–¥–∞ –≤–∏–Ω–∞ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ –≤–∏–Ω—É, –∞ –ø—Ä–æ –∑–∞–±–æ—Ç—É –æ –¥—Ä—É–≥–∏—Ö. üåø",
        "–ü–æ—Ö–æ–∂–µ, —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. ü§ç –ü—Ä–∏–∑–Ω–∞–π —ç—Ç–æ ‚Äî –∏ –Ω–µ –∫–æ—Ä–∏ —Å–µ–±—è —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ. –ú—ã –º—è–≥–∫–æ –≤–µ—Ä–Ω—ë–º—Å—è –∫ —ç—Ç–æ–º—É –ø–æ–∑–∂–µ. üåô",
        "–í–∏–Ω–∞ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–≤–æ–µ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. üí´ –ù–æ —Ç—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–µ—Å—Ç–∏ –≤—Å—ë –æ–¥–∏–Ω."
    ],
    "shame": [
        "–ü–æ—Ö–æ–∂–µ, —Ç–µ–±–µ –Ω–µ–ª–æ–≤–∫–æ –∏–ª–∏ —Å—Ç—ã–¥–Ω–æ. üå´ –≠—Ç–æ —á—É–≤—Å—Ç–≤–æ —á–∞—Å—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –º—ã –±–æ–∏–º—Å—è –±—ã—Ç—å –Ω–µ–ø—Ä–∏–Ω—è—Ç—ã–º–∏. –ù–æ –∑–¥–µ—Å—å ‚Äî —Ç–µ–±—è –Ω–µ –æ—Å—É–∂–¥–∞—é—Ç. üåø",
        "–¢—ã —É–ø–æ–º—è–Ω—É–ª —Å—Ç—ã–¥. –≠—Ç–æ —Ç—Ä—É–¥–Ω–æ ‚Äî –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å –µ–≥–æ. üí≠ –ù–æ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —Å–∏–ª—å–Ω–µ–µ. ü§ç",
        "–°—Ç—ã–¥ —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã —Ç–µ–±—è –ø—Ä–∏–Ω—è–ª–∏. üå∏ –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–Ω–µ—Å—Ç–∏—Å—å –∫ —Å–µ–±–µ –º—è–≥—á–µ."
    ],
    "loneliness": [
        "–ü–æ—Ö–æ–∂–µ, –≤–Ω—É—Ç—Ä–∏ –µ—Å—Ç—å –æ—â—É—â–µ–Ω–∏–µ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–∞. üåå –≠—Ç–æ –∑–Ω–∞–∫–æ–º–æ –º–Ω–æ–≥–∏–º. –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å ‚Äî —Ç—ã –Ω–µ –æ–¥–∏–Ω. üåø",
        "–û—â—É—â–∞—Ç—å –ø—É—Å—Ç–æ—Ç—É —Ä—è–¥–æ–º —Å –¥—Ä—É–≥–∏–º–∏ ‚Äî –±–æ–ª—å–Ω–æ. üí≠ –ù–æ –¥–∞–∂–µ —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –±—ã—Ç—å. ü§ç",
        "–¢—ã –Ω–µ –æ–¥–∏–Ω–æ–∫, —Ö–æ—Ç—è —Å–µ–π—á–∞—Å –º–æ–∂–µ—Ç –∫–∞–∑–∞—Ç—å—Å—è –∏–Ω–∞—á–µ. –ú—ã –∫–æ—Å–Ω—ë–º—Å—è —ç—Ç–æ–π —Ç–µ–º—ã –≤–º–µ—Å—Ç–µ. üåô"
    ],
    "burnout": [
        "–ü–æ—Ö–æ–∂–µ, —Ç—ã –≤—ã–º–æ—Ç–∞–Ω. üîã –£—Å—Ç–∞–ª–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–Ω–∞–∫–æ–º, —á—Ç–æ —Ç—ã —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –¥–µ—Ä–∂–∞–ª—Å—è. –ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –Ω–µ–º–Ω–æ–≥–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è. üåø",
        "–¢—ã –∑–≤—É—á–∏—à—å –∏—Å—Ç–æ—â—ë–Ω–Ω–æ. üí≠ –ò–Ω–æ–≥–¥–∞ –ª—É—á—à–µ–µ, —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–µ–ª–∞—Ç—å. –ú—ã –≤–µ—Ä–Ω—ë–º—Å—è –∫ —ç—Ç–æ–º—É –Ω–∞ —Ä–∞–∑–±–æ—Ä–µ. üïØ",
        "–í—ã–≥–æ—Ä–∞–Ω–∏–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ ‚Äî –æ–Ω–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è. üí¨ –ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –≤—ã–¥–æ—Ö–Ω—É—Ç—å."
    ],
    "fatigue": [
        "–¢—ã —É—Å—Ç–∞–ª. üòî –ò–Ω–æ–≥–¥–∞ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ —Ç–µ–ª–æ, –∞ –ø—Ä–æ –¥—É—à—É. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å, –¥–∞–∂–µ –Ω–∞ –ø–∞—Ä—É –º–∏–Ω—É—Ç. üåø",
        "–ü–æ—Ö–æ–∂–µ, —Å–∏–ª —Å–æ–≤—Å–µ–º –º–∞–ª–æ. üí≠ –≠—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ ‚Äî –º—ã –Ω–µ –º–∞—à–∏–Ω—ã. –ú—ã –∫–æ—Å–Ω—ë–º—Å—è —ç—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ —Ä–∞–∑–±–æ—Ä–µ. üïØ",
        "–ò–Ω–æ–≥–¥–∞ —É—Å—Ç–∞–ª–æ—Å—Ç—å ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—å–±–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –º–∏—Ä–∞: ¬´–∑–∞–º–µ—Ç—å –º–µ–Ω—è¬ª. üí´"
    ],
    "general": [
        "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–µ–ª–∏—à—å—Å—è. üåø –í—Å—ë, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ. –ú—ã –≥–ª—É–±–∂–µ –æ–±—Å—É–¥–∏–º —ç—Ç—É —Ç–µ–º—É –Ω–∞ –≥—Ä—É–ø–ø–æ–≤–æ–º —Ä–∞–∑–±–æ—Ä–µ. üïä",
        "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–µ–ª–∏—à—å—Å—è —ç—Ç–∏–º. üí¨ –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞—Ç—Ä–æ–Ω–µ–º —ç—Ç–æ –Ω–∞ —Ä–∞–∑–±–æ—Ä–µ ‚Äî —Ç–æ, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–æ.",
        "–¢—ã —Å–µ–π—á–∞—Å –æ–±–æ–∑–Ω–∞—á–∞–µ—à—å —Ç–æ, —á—Ç–æ –Ω–µ –∫–∞–∂–¥—ã–π —Ä–µ—à–∞–µ—Ç—Å—è —Å–∫–∞–∑–∞—Ç—å. üí¨ –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ–± —ç—Ç–æ–º –≥–ª—É–±–∂–µ –Ω–∞ —Ä–∞–∑–±–æ—Ä–µ"
    ]
}

# --- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–º—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º ---
def detect_topic(text):
    text = text.lower()
    topic_keywords = {
        "sadness": ["–≥—Ä—É—Å—Ç", "–ø–µ—á–∞–ª—å", "—Ç–æ—Å–∫–∞", "—Å–ª–µ–∑", "–æ–¥–∏–Ω–æ–∫–æ"],
        "anxiety": ["—Ç—Ä–µ–≤–æ–≥", "—Å—Ç—Ä–∞—Ö", "–ø–∞–Ω–∏–∫", "–Ω–µ—Ä–≤–Ω–∏", "–±–æ—é—Å—å"],
        "joy": ["—Ä–∞–¥–æ—Å—Ç—å", "—Å—á–∞—Å—Ç—å–µ", "–¥–æ–≤–æ–ª–µ–Ω", "–∫–∞–π—Ñ", "–≤–¥–æ—Ö–Ω–æ–≤–ª"],
        "anger": ["–∑–ª–æ—Å—Ç—å", "—Ä–∞–∑–¥—Ä–∞–∂", "–±–µ—Å–∏—Ç", "—è—Ä–æ—Å—Ç—å", "–∞–≥—Ä–µ—Å"],
        "fear": ["—Å—Ç—Ä–∞—à–Ω–æ", "—É–∂–∞—Å", "–ø–∞–Ω–∏–∫–∞", "–æ–ø–∞—Å–∞—é—Å—å"],
        "guilt": ["–≤–∏–Ω–æ–≤–∞—Ç", "–≤–∏–Ω–∞", "—Å–æ–≤–µ—Å—Ç—å", "—Å–æ–∂–∞–ª"],
        "shame": ["—Å—Ç—ã–¥", "–Ω–µ–ª–æ–≤–∫–æ", "–Ω–µ—É–¥–æ–±–Ω–æ", "–ø–æ–∑–æ—Ä"],
        "loneliness": ["–æ–¥–∏–Ω", "–ø—É—Å—Ç–æ", "–Ω–∏–∫–æ–≥–æ", "–∑–∞–±—ã—Ç"],
        "burnout": ["–≤—ã–≥–æ—Ä–µ–ª", "–∏—Å—Ç–æ—â–µ–Ω", "–æ–ø—É—Å—Ç–æ—à–µ–Ω"],
        "fatigue": ["—É—Å—Ç–∞–ª", "–∏–∑–º–æ—Ç–∞–Ω", "–±–µ–∑ —Å–∏–ª"],
    }
    for topic, words in topic_keywords.items():
        if any(w in text for w in words):
            return topic
    return "general"

# --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–ø–∞—Ç–∏—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ---
def generate_empathic_response(user_text):
    topic = detect_topic(user_text)
    response = random.choice(RESPONSES.get(topic, RESPONSES["general"]))
    return response

# --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ ---
def save_dialog(user_id, user_text, bot_response):
    filename = f"dialogs/{user_id}.txt"
    with open(filename, "a", encoding="utf-8") as f:
        f.write(f"[{datetime.now().strftime('%d.%m.%Y %H:%M:%S')}]\n")
        f.write(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_text}\n")
        f.write(f"–ë–æ—Ç: {bot_response}\n\n")

# === Telegram –ª–æ–≥–∏–∫–∞ ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    await update.message.reply_text(
        "ü¶â –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –°–æ–≤–∞. –ì–æ–≤–æ—Ä–∏ –≤—Å—ë, —á—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—à—å, —è —Ä—è–¥–æ–º. –ü–æ–∑–∂–µ –¥–µ—Ç–∞–ª—å–Ω–µ–µ –ø–æ–º–æ–∂–µ–º –ø–æ–Ω—è—Ç—å —Ç–≤–æ–∏ —á—É–≤—Ç—Å—Ç–≤–∞ –Ω–∞ –≥—Ä—É–ø–ø–æ–≤–æ–º —Ä–∞–∑–±–æ—Ä–µ üí¨"
    )
    users[user_id] = {}
    user_states[user_id] = {"last_topic": None}
    return MAIN

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_text = update.message.text
    response = generate_empathic_response(user_text)
    save_dialog(user_id, user_text, response)
    await update.message.reply_text(response)

def main():
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω ‚Äî —Å–ª—É—à–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.")
    app = Application.builder().token(BOT_TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={MAIN: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)]},
        fallbacks=[],
    )

    app.add_handler(conv_handler)
    app.run_polling()

if __name__ == "__main__":
    main()
